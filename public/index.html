<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Matthew Kane - Portfolio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }
    
    /* Login Gate */
    .login-gate {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .login-box {
      background: white;
      padding: 3rem;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .login-box h2 { color: #667eea; margin-bottom: 1rem; }
    .disclaimer {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 1rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      text-align: left;
      font-size: 0.9rem;
      color: #856404;
    }
    .disclaimer strong { display: block; margin-bottom: 0.5rem; color: #721c24; }
    
    /* Navbar */
    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .navbar .welcome {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .navbar .nav-links {
      display: flex;
      gap: 1.5rem;
    }
    .navbar .nav-links a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: background 0.3s;
      cursor: pointer;
    }
    .navbar .nav-links a:hover {
      background: rgba(255,255,255,0.2);
    }
    .navbar .nav-links a.active {
      background: rgba(255,255,255,0.3);
    }
    
    /* Portfolio Page */
    .portfolio-page {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    .portfolio-page.hidden {
      display: none;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 3rem 2rem;
      text-align: center;
    }
    .header h1 { 
      font-size: 2.8rem; 
      margin-bottom: 0.5rem; 
      font-weight: 700;
    }
    .header h3 { 
      font-size: 1.3rem; 
      opacity: 0.95; 
      font-weight: 400; 
      line-height: 1.5;
    }
    .content { 
      padding: 2.5rem; 
    }
    section { 
      margin-bottom: 3rem; 
    }
    h2 { 
      color: #667eea; 
      font-size: 1.8rem;
      margin-bottom: 1.5rem; 
      border-bottom: 3px solid #667eea; 
      padding-bottom: 0.75rem;
    }
    p { 
      line-height: 1.8; 
      color: #2c3e50; 
      font-size: 1.05rem;
    }
    
    /* Summary Box */
    .summary-box {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
      padding: 2rem;
      border-radius: 12px;
      border-left: 5px solid #667eea;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    /* Skills Grid */
    #skills {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
      list-style: none;
      padding: 0;
    }
    #skills li { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #skills li:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    /* Experience Cards */
    .job { 
      margin-bottom: 2rem; 
      padding: 1.75rem;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #667eea;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .job:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
    }
    .job h3 { 
      color: #2c3e50; 
      margin-bottom: 0.5rem; 
      font-size: 1.3rem;
    }
    .job .meta { 
      color: #667eea; 
      font-size: 0.95rem; 
      margin-bottom: 1rem; 
      font-weight: 600;
    }
    .job ul { 
      list-style: none; 
      margin-left: 0; 
      display: block;
      padding: 0;
    }
    .job ul li { 
      background: none; 
      padding: 0;
      padding-left: 1.75rem;
      border-radius: 0;
      color: #34495e;
      margin-bottom: 0.75rem;
      position: relative;
      line-height: 1.6;
    }
    .job ul li:before {
      content: "‚ñ∏";
      position: absolute;
      left: 0;
      color: #667eea;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    /* Education Cards */
    .edu-item {
      margin-bottom: 1.25rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #28a745;
      transition: transform 0.2s;
    }
    .edu-item:hover {
      transform: translateX(5px);
    }
    .edu-item h4 { 
      color: #2c3e50; 
      margin-bottom: 0.5rem; 
      font-size: 1.2rem;
    }
    .edu-item .institution { 
      color: #28a745; 
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    /* Projects Grid */
    #projects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    .project-card {
      padding: 1.75rem;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 12px;
      border-top: 4px solid #764ba2;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .project-card h4 { 
      color: #2c3e50; 
      margin-bottom: 0.75rem; 
      font-size: 1.2rem;
    }
    .project-card .tech { 
      color: #667eea; 
      font-size: 0.9rem; 
      margin-bottom: 0.75rem;
      font-weight: 600;
    }
    .project-card p {
      color: #34495e;
      line-height: 1.6;
    }
    
    /* Admin Page */
    .admin-page {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    .admin-page.hidden {
      display: none;
    }
    .admin-controls {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .admin-controls h2 {
      color: #667eea;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #333;
      font-weight: 600;
    }
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      padding: 0.75rem 1.5rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.3s;
    }
    button:hover {
      background: #5568d3;
    }
    .admin-table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .admin-table-container h2 {
      padding: 1.5rem;
      margin: 0;
      background: #f8f9fa;
      border-bottom: 2px solid #667eea;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background: #667eea;
      color: white;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
    }
    td {
      padding: 1rem;
      border-bottom: 1px solid #eee;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status-badge.active {
      background: #d4edda;
      color: #155724;
    }
    .status-badge.inactive {
      background: #f8d7da;
      color: #721c24;
    }
    .action-btn {
      padding: 0.4rem 0.8rem;
      margin: 0 0.25rem;
      font-size: 0.9rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .action-btn.toggle {
      background: #ffc107;
      color: #333;
    }
    .action-btn.toggle:hover {
      background: #e0a800;
    }
    .action-btn.delete {
      background: #dc3545;
      color: white;
    }
    .action-btn.delete:hover {
      background: #c82333;
    }
    .action-btn.view-chat {
      background: #28a745;
      color: white;
    }
    .action-btn.view-chat:hover {
      background: #218838;
    }
    
    /* Chat Modal */
    .chat-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .chat-modal.open {
      display: flex;
    }
    .chat-modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .chat-modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 16px 16px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-modal-header h3 {
      margin: 0;
      font-size: 1.3rem;
    }
    .chat-modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 35px;
      height: 35px;
      line-height: 1;
    }
    .chat-modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }
    .chat-log-message {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid;
    }
    .chat-log-message.user-message {
      background: #e3f2fd;
      border-left-color: #2196f3;
    }
    .chat-log-message.assistant-message {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    .chat-log-message .message-meta {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .chat-log-message .message-content {
      color: #333;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .no-chat-messages {
      text-align: center;
      padding: 3rem;
      color: #666;
      font-size: 1.1rem;
    }
    
    /* Chat Bubble */
    .chat-bubble-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    .chat-bubble-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .chat-bubble-btn:hover {
      transform: scale(1.1);
    }
    .chat-window {
      display: none;
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 500px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      flex-direction: column;
      overflow: hidden;
    }
    .chat-window.open {
      display: flex;
    }
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #f8f9fa;
    }
    .chat-input-area {
      padding: 1rem;
      border-top: 1px solid #ddd;
      background: white;
    }
    .chat-input-area textarea {
      width: 100%;
      min-height: 60px;
      margin-bottom: 0.5rem;
      resize: none;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
    }
    .chat-input-area button {
      width: 100%;
    }
    .msg-user { 
      color: #333; 
      margin: 0.75rem 0;
      padding: 0.75rem;
      background: #e3f2fd;
      border-radius: 8px;
      border-left: 3px solid #2196f3;
      word-wrap: break-word;
    }
    .msg-assistant { 
      color: #1b5e20; 
      margin: 0.75rem 0;
      padding: 0.75rem;
      background: #e8f5e9;
      border-radius: 8px;
      border-left: 3px solid #4caf50;
      word-wrap: break-word;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }
      .navbar .nav-links {
        width: 100%;
        justify-content: center;
      }
      .portfolio-page {
        padding: 0 1rem;
        margin: 1rem auto;
      }
      .content {
        padding: 1.5rem;
      }
      .header {
        padding: 2rem 1.5rem;
      }
      .header h1 {
        font-size: 2rem;
      }
      .header h3 {
        font-size: 1.1rem;
      }
      #skills {
        grid-template-columns: 1fr;
      }
      #projects {
        grid-template-columns: 1fr;
      }
      .chat-window {
        width: calc(100vw - 40px);
        right: 20px;
        left: 20px;
      }
      .admin-page {
        padding: 0 1rem;
      }
      table {
        font-size: 0.85rem;
      }
      td, th {
        padding: 0.75rem 0.5rem;
      }
      .action-btn {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        margin: 0.1rem;
      }
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.5rem;
      }
      .header h3 {
        font-size: 1rem;
      }
      section h2 {
        font-size: 1.4rem;
      }
      .job h3 {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Login Gate -->
  <div id="loginGate" class="login-gate">
    <div class="login-box">
      <h2>üîê Access Portfolio</h2>
      <div class="disclaimer">
        <strong>‚ö†Ô∏è Recruiter/Employer Access Only</strong>
        This portfolio contains professional information intended exclusively for recruiters, hiring managers, and potential employers reviewing Matthew Kane's qualifications. By entering a login code, you confirm you are accessing this information for legitimate employment consideration purposes.
      </div>
      <div style="margin: 2rem 0;">
        <input id="accessCode" type="text" placeholder="Enter your login code" style="width: 100%; padding: 1rem; font-size: 1rem; margin-bottom: 1rem; border: 2px solid #ddd; border-radius: 6px;" />
        <button onclick="attemptLogin()" style="width: 100%; padding: 1rem; font-size: 1rem;">Access Portfolio</button>
        <div id="loginError" style="color: #dc3545; margin-top: 1rem; display: none;"></div>
      </div>
      <p style="font-size: 0.9rem; color: #666;">
        Don't have a code? Contact Matthew at <a href="mailto:Mkane8971@gmail.com" style="color: #667eea;">Mkane8971@gmail.com</a>
      </p>
    </div>
  </div>

  <!-- Main App (hidden until login) -->
  <div id="mainApp" style="display: none;">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="welcome">Welcome, <span id="userName"></span>!</div>
      <div class="nav-links">
        <a onclick="showPortfolio()" id="navPortfolio" class="active">Portfolio</a>
        <a onclick="showAdmin()" id="navAdmin" style="display: none;">Admin</a>
        <a onclick="logout()">Logout</a>
      </div>
    </nav>

    <!-- Portfolio Page -->
    <div id="portfolioPage" class="portfolio-page">
      <div class="container">
        <div class="header">
          <h1 id="name"></h1>
          <h3 id="title"></h3>
        </div>
        <div class="content">
          <section>
            <h2>üëã About Me</h2>
            <div class="summary-box">
              <p id="summary"></p>
            </div>
          </section>
          
          <section>
            <h2>üíº Professional Experience</h2>
            <div id="experience"></div>
          </section>

          <section>
            <h2>üõ†Ô∏è Technical Skills & Expertise</h2>
            <ul id="skills"></ul>
          </section>

          <section>
            <h2>üéì Education & Certifications</h2>
            <div id="education"></div>
          </section>

          <section>
            <h2>üöÄ Featured Projects & Leadership</h2>
            <div id="projects"></div>
          </section>
        </div>
      </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="admin-page hidden">
      <div class="admin-controls">
        <h2>Create Employer Login Code</h2>
        <div class="form-group">
          <label>Company/Employer Name</label>
          <input id="companyName" type="text" placeholder="e.g., ABC Corp" />
        </div>
        <div class="form-group">
          <label>Login Code</label>
          <input id="companyCode" type="text" placeholder="e.g., abc-2024" />
        </div>
        <button onclick="createCompany()">Create Login Code</button>
      </div>

      <div class="admin-table-container">
        <h2>Employer Login Codes</h2>
        <table>
          <thead>
            <tr>
              <th>Company/Employer</th>
              <th>Login Code</th>
              <th>Status</th>
              <th>Chat Questions</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="companiesTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Chat Log Modal -->
    <div id="chatModal" class="chat-modal">
      <div class="chat-modal-content">
        <div class="chat-modal-header">
          <h3 id="chatModalTitle">Chat History</h3>
          <button class="chat-modal-close" onclick="closeChatModal()">√ó</button>
        </div>
        <div class="chat-modal-body" id="chatModalBody">
          <!-- Chat messages will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Bubble -->
  <div class="chat-bubble-container">
    <button class="chat-bubble-btn" onclick="toggleChat()">üí¨</button>
    <div id="chatWindow" class="chat-window">
      <div class="chat-header">
        <span>Ask About Matthew</span>
        <button class="chat-close" onclick="toggleChat()">√ó</button>
      </div>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input-area">
        <textarea id="chatInputBubble" placeholder="Ask about experience, skills, background..."></textarea>
        <button onclick="sendChatBubble()">Send</button>
      </div>
    </div>
  </div>

<script>
let currentUser = null;
let isAdmin = false;
let sessionId = null;
let questionsRemaining = 3;
const apiBase = '/api';
const ADMIN_CODE = 'admin-mkane-2024';

// Login gate functions
async function attemptLogin() {
  const code = document.getElementById('accessCode').value.trim();
  const errorDiv = document.getElementById('loginError');
  
  if (!code) {
    errorDiv.textContent = 'Please enter a login code';
    errorDiv.style.display = 'block';
    return;
  }

  try {
    const res = await fetch(`${apiBase}/login-code`, { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ code }) 
    });
    const data = await res.json();
    
    if (data.valid) {
      currentUser = data.company;
      isAdmin = (code === ADMIN_CODE);
      questionsRemaining = 3 - (data.company.chat_questions_used || 0);
      
      // Show main app
      document.getElementById('loginGate').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      
      // Update navbar
      document.getElementById('userName').textContent = currentUser.name;
      if (isAdmin) {
        document.getElementById('navAdmin').style.display = 'block';
      }
      
      // Load portfolio
      fetchProfile();
      
      // Load chat history
      loadChatHistory();
    } else {
      errorDiv.textContent = data.message || 'Invalid or inactive login code. Please contact Matthew for access.';
      errorDiv.style.display = 'block';
    }
  } catch (err) {
    errorDiv.textContent = 'Connection error. Please try again.';
    errorDiv.style.display = 'block';
  }
}

// Navigation functions
function showPortfolio() {
  document.getElementById('portfolioPage').classList.remove('hidden');
  document.getElementById('adminPage').classList.add('hidden');
  document.getElementById('navPortfolio').classList.add('active');
  document.getElementById('navAdmin').classList.remove('active');
}

function showAdmin() {
  if (!isAdmin) {
    alert('Access denied. Admin only.');
    return;
  }
  document.getElementById('portfolioPage').classList.add('hidden');
  document.getElementById('adminPage').classList.remove('hidden');
  document.getElementById('navPortfolio').classList.remove('active');
  document.getElementById('navAdmin').classList.add('active');
  loadCompanies();
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    location.reload();
  }
}

// Allow Enter key to submit login
document.addEventListener('DOMContentLoaded', () => {
  const accessCodeInput = document.getElementById('accessCode');
  if (accessCodeInput) {
    accessCodeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') attemptLogin();
    });
  }
});

// Chat bubble functions
async function loadChatHistory() {
  try {
    const res = await fetch(`${apiBase}/chat-history/${currentUser.login_code}`);
    const data = await res.json();
    
    if (data.messages && data.messages.length > 0) {
      // Load existing messages
      data.messages.forEach(msg => {
        appendChatBubble(msg.role, msg.content);
      });
    } else {
      // Show welcome message if no history
      showChatWelcome();
    }
  } catch (err) {
    console.error('Error loading chat history:', err);
    showChatWelcome();
  }
}

function toggleChat() {
  const chatWindow = document.getElementById('chatWindow');
  chatWindow.classList.toggle('open');
}

function showChatWelcome() {
  const welcomeMsg = `üëã Hi! I'm here to answer questions about Matthew's background. You have ${questionsRemaining} question${questionsRemaining !== 1 ? 's' : ''} remaining.

Try asking:
‚Ä¢ "What's his experience in healthcare IT?"
‚Ä¢ "Tell me about his technical skills"
‚Ä¢ "What projects has he worked on?"`;
  
  appendChatBubble('assistant', welcomeMsg);
}

function appendChatBubble(role, content) {
  const div = document.createElement('div');
  div.className = role === 'assistant' ? 'msg-assistant' : (role === 'loading' ? 'msg-assistant' : 'msg-user');
  div.textContent = content;
  if (role === 'loading') {
    div.id = 'loadingMessage';
  }
  document.getElementById('chatMessages').appendChild(div);
  document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
}

async function sendChatBubble() {
  const input = document.getElementById('chatInputBubble');
  const text = input.value.trim();
  if (!text) return;
  
  if (questionsRemaining <= 0) {
    appendChatBubble('assistant', "You've used all 3 questions. Please contact Matthew at Mkane8971@gmail.com for more information.");
    return;
  }
  
  appendChatBubble('user', text);
  input.value = '';
  
  // Show loading message
  appendChatBubble('loading', 'Loading...');
  
  try {
    const res = await fetch(`${apiBase}/chat`, { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ 
        messages: [{ role: 'user', content: text }], 
        session_id: sessionId,
        login_code: currentUser.login_code
      }) 
    });
    const data = await res.json();
    
    // Remove loading message
    const loadingMsg = document.getElementById('loadingMessage');
    if (loadingMsg) loadingMsg.remove();
    
    sessionId = data.session_id;
    appendChatBubble('assistant', data.reply);
    
    // Update questions remaining
    if (data.questions_remaining !== undefined) {
      questionsRemaining = data.questions_remaining;
      if (questionsRemaining === 0) {
        appendChatBubble('assistant', `That was your last question! For more info, email Matthew at Mkane8971@gmail.com`);
      }
    }
  } catch (err) {
    // Remove loading message
    const loadingMsg = document.getElementById('loadingMessage');
    if (loadingMsg) loadingMsg.remove();
    
    appendChatBubble('assistant', 'Sorry, there was an error. Please try again.');
  }
}

// Allow Enter key to send chat (Shift+Enter for new line)
document.addEventListener('DOMContentLoaded', () => {
  const chatInput = document.getElementById('chatInputBubble');
  if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatBubble();
      }
    });
  }
});

// Portfolio functions
async function fetchProfile() {
  const res = await fetch(`${apiBase}/profile`);
  const data = await res.json();
  document.getElementById('name').textContent = data.full_name;
  document.getElementById('title').textContent = data.title;
  document.getElementById('summary').textContent = data.summary;
  
  // Skills
  const skillsUl = document.getElementById('skills');
  skillsUl.innerHTML = '';
  (data.skills || []).forEach(s => {
    const li = document.createElement('li');
    li.textContent = s; 
    skillsUl.appendChild(li);
  });

  // Experience
  const expDiv = document.getElementById('experience');
  expDiv.innerHTML = '';
  (data.experience || []).forEach(job => {
    const jobDiv = document.createElement('div');
    jobDiv.className = 'job';
    const meta = [job.company, job.period, job.location].filter(Boolean).join(' | ');
    jobDiv.innerHTML = `
      <h3>${job.title}</h3>
      <div class="meta">${meta}</div>
      <ul>
        ${(Array.isArray(job.responsibilities) ? job.responsibilities : []).map(r => `<li>${r}</li>`).join('')}
      </ul>
    `;
    expDiv.appendChild(jobDiv);
  });

  // Education
  const eduDiv = document.getElementById('education');
  eduDiv.innerHTML = '';
  (data.education || []).forEach(edu => {
    const eduItem = document.createElement('div');
    eduItem.className = 'edu-item';
    const details = edu.details || edu.detail || edu.notes || edu.note || '';
    const degree = edu.degree || edu.program || '';
    const status = edu.status || edu.completion || '';
    eduItem.innerHTML = `
      <h4>${degree}</h4>
      <div class="institution">${edu.institution}</div>
      ${details ? `<div style="color:#666;margin-top:0.5rem;">${details}</div>` : ''}
      ${status ? `<div style="color:#667eea;font-weight:600;margin-top:0.25rem;">${status}</div>` : ''}
    `;
    eduDiv.appendChild(eduItem);
  });

  // Projects
  const projDiv = document.getElementById('projects');
  projDiv.innerHTML = '';
  (data.projects || []).forEach(proj => {
    const projCard = document.createElement('div');
    projCard.className = 'project-card';
    projCard.innerHTML = `
      <h4>${proj.name}${proj.organization ? ` - ${proj.organization}` : ''}</h4>
      ${proj.tech ? `<div class="tech">Tech Stack: ${proj.tech}</div>` : ''}
      <p>${proj.description}</p>
    `;
    projDiv.appendChild(projCard);
  });
}

// Admin functions
async function loadCompanies() {
  const res = await fetch(`${apiBase}/companies`);
  const data = await res.json();
  const tbody = document.getElementById('companiesTable');
  tbody.innerHTML = '';
  
  data.forEach(c => {
    const tr = document.createElement('tr');
    const isActive = c.is_active === undefined || c.is_active === 1 || c.is_active === true;
    const createdDate = new Date(c.created_at).toLocaleDateString();
    const questionsUsed = c.chat_questions_used || 0;
    
    tr.innerHTML = `
      <td>${c.name}</td>
      <td><code>${c.login_code}</code></td>
      <td><span class="status-badge ${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span></td>
      <td>${questionsUsed} / 3</td>
      <td>${createdDate}</td>
      <td>
        <button class="action-btn view-chat" onclick="viewChatLogs('${c.login_code}', '${c.name}')">View Chats</button>
        <button class="action-btn toggle" onclick="toggleCompanyStatus(${c.id}, ${isActive})">${isActive ? 'Deactivate' : 'Activate'}</button>
        <button class="action-btn" onclick="resetChatQuestions(${c.id})" style="background:#17a2b8;color:white;">Reset Chat</button>
        <button class="action-btn delete" onclick="deleteCompany(${c.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function createCompany() {
  const name = document.getElementById('companyName').value.trim();
  const login_code = document.getElementById('companyCode').value.trim();
  
  if (!name || !login_code) {
    alert('Please fill in both fields');
    return;
  }
  
  try {
    const res = await fetch(`${apiBase}/companies`, { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ name, login_code }) 
    });
    
    if (res.ok) {
      document.getElementById('companyName').value = '';
      document.getElementById('companyCode').value = '';
      loadCompanies();
      alert('Login code created successfully!');
    } else {
      const err = await res.json();
      alert('Failed to create: ' + (err.error || 'Unknown error'));
    }
  } catch (err) {
    alert('Error creating login code');
  }
}

async function toggleCompanyStatus(id, currentStatus) {
  const newStatus = !currentStatus;
  try {
    const res = await fetch(`${apiBase}/companies/${id}`, { 
      method: 'PUT', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ is_active: newStatus ? 1 : 0 }) 
    });
    
    if (res.ok) {
      loadCompanies();
    } else {
      alert('Failed to update status');
    }
  } catch (err) {
    alert('Error updating status');
  }
}

async function deleteCompany(id) {
  if (!confirm('Are you sure you want to delete this login code?')) return;
  
  try {
    const res = await fetch(`${apiBase}/companies/${id}`, { 
      method: 'DELETE'
    });
    
    if (res.ok) {
      loadCompanies();
      alert('Login code deleted successfully');
    } else {
      alert('Failed to delete');
    }
  } catch (err) {
    alert('Error deleting login code');
  }
}

async function resetChatQuestions(id) {
  if (!confirm('Reset chat questions for this employer? This will give them 3 new questions.')) return;
  
  try {
    const res = await fetch(`${apiBase}/companies/${id}/reset-chat`, { 
      method: 'POST'
    });
    
    if (res.ok) {
      loadCompanies();
      alert('Chat questions reset successfully! User now has 3 questions available.');
    } else {
      alert('Failed to reset chat questions');
    }
  } catch (err) {
    alert('Error resetting chat questions');
  }
}

// Chat viewing functions
async function viewChatLogs(loginCode, companyName) {
  try {
    const res = await fetch(`${apiBase}/chat-history/${loginCode}`);
    const data = await res.json();
    
    // Update modal title
    document.getElementById('chatModalTitle').textContent = `Chat History - ${companyName}`;
    
    // Populate modal body
    const modalBody = document.getElementById('chatModalBody');
    modalBody.innerHTML = '';
    
    if (data.messages && data.messages.length > 0) {
      data.messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-log-message ${msg.role === 'user' ? 'user-message' : 'assistant-message'}`;
        
        const timestamp = new Date(msg.created_at).toLocaleString();
        const roleLabel = msg.role === 'user' ? 'üë§ User' : 'ü§ñ Assistant';
        
        messageDiv.innerHTML = `
          <div class="message-meta">${roleLabel} - ${timestamp}</div>
          <div class="message-content">${escapeHtml(msg.content)}</div>
        `;
        
        modalBody.appendChild(messageDiv);
      });
    } else {
      modalBody.innerHTML = '<div class="no-chat-messages">üì≠ No chat messages yet</div>';
    }
    
    // Show modal
    document.getElementById('chatModal').classList.add('open');
  } catch (err) {
    console.error('Error loading chat logs:', err);
    alert('Failed to load chat history');
  }
}

function closeChatModal() {
  document.getElementById('chatModal').classList.remove('open');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
  const modal = document.getElementById('chatModal');
  if (e.target === modal) {
    closeChatModal();
  }
});

</script>
</body>
</html>
